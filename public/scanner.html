<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner OMAGGI 2026 </title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- html5-qrcode library -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="text-center mb-4">QR Scanner 2026</h1>
    <div class="card mx-auto" style="max-width: 400px;">
      <div class="card-body">
        <!-- Div per la visualizzazione della fotocamera -->
        <div id="qr-reader" style="width:100%;"></div>
        <!-- Area per mostrare i risultati -->
        <div id="qr-reader-results" class="mt-3"></div>
        <!-- Pulsanti per avviare e fermare lo scanner -->
        <button id="startScanner" class="btn btn-primary mt-3">Avvia Scanner</button>
        <button id="stopScanner" class="btn btn-secondary mt-3 d-none">Ferma Scanner</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle (con Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const startBtn = document.getElementById("startScanner");
    const stopBtn = document.getElementById("stopScanner");
    const resultsDiv = document.getElementById("qr-reader-results");
    let html5QrCode;
    let scannedOnce = false; // Flag per interrompere la scansione al primo QR code

    startBtn.addEventListener("click", () => {
      // Reset flag e aggiorna pulsanti
      scannedOnce = false;
      startBtn.classList.add("d-none");
      stopBtn.classList.remove("d-none");

      // Inizializza l'istanza di html5Qrcode sull'elemento con id "qr-reader"
      html5QrCode = new Html5Qrcode("qr-reader");

      html5QrCode.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: 250
        },
        (decodedText, decodedResult) => {
          // Se è la prima scansione, ferma lo scanner e processa il risultato
          if (!scannedOnce) {
            scannedOnce = true;
            resultsDiv.innerHTML = `<div class="alert alert-success">QR Code rilevato: ${decodedText}</div>`;
            console.log("QR Code decodificato:", decodedText);
            
            // Ferma lo scanner
            html5QrCode.stop().then(() => {
              console.log("Scanner fermato automaticamente dopo il QR code.");
              stopBtn.classList.add("d-none");
              startBtn.classList.remove("d-none");
            }).catch(err => {
              console.error("Errore nello stop dello scanner:", err);
            });

            // Estrai il token dal testo decodificato
            let token;
            try {
                const decodedObj = JSON.parse(decodedText);
                token = decodedObj.token;
                if (!token) {
                    throw new Error("Token non presente nel QR code.");
                }
            } catch (e) {
                // Se il QR code non è in formato JSON, usa direttamente la stringa
                token = decodedText.trim();
                if (!token) {
                    resultsDiv.innerHTML += `<div class="alert alert-info">Token non valido.</div>`;
                    return;
                }
            }

            // Invia solo il token a validate.php tramite GET
            fetch("validate.php?token=" + encodeURIComponent(token))
                .then(response => response.text())
                .then(text => {
                    resultsDiv.innerHTML += `<div class="alert alert-danger">${text}</div>`;
                    console.log("Risposta da validate.php:", text);
                })
                .catch(err => {
                    resultsDiv.innerHTML += `<div class="alert alert-info">Errore nella validazione: ${err}</div>`;
                    console.error("Errore nella validazione:", err);
                });
          }
        });
    });
    stopBtn.addEventListener("click", () => {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          resultsDiv.innerHTML += `<div class="alert alert-danger">Scanner fermato.</div>`;
          html5QrCode.clear();
          startBtn.classList.remove("d-none");
          stopBtn.classList.add("d-none");          
        }).catch(err => {
          resultsDiv.innerHTML += `<div class="alert alert-info">Errore nello stop dello scanner: ${err}</div>`;
          console.error("Errore nello stop dello scanner:", err);
        });
      }
    });
  </script>
</body>
</html>
